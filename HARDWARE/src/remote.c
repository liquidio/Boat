#include "remote.h"
#include "delay.h"
#include "usart.h"
#include "led.h"
//////////////////////////////////////////////////////////////////////////////////	 
//±æ≥Ã–Ú÷ªπ©—ßœ∞ π”√£¨Œ¥æ≠◊˜’ﬂ–Ìø…£¨≤ªµ√”√”⁄∆‰À¸»Œ∫Œ”√Õæ
//ALIENTEK miniSTM32ø™∑¢∞Â
//∫ÏÕ‚“£øÿΩ‚¬Î«˝∂Ø ¥˙¬Î	   
//’˝µ„‘≠◊”@ALIENTEK
//ºº ı¬€Ã≥:www.openedv.com
//–ﬁ∏ƒ»’∆⁄:2012/9/12
//∞Ê±æ£∫V1.0
//∞Ê»®À˘”–£¨µ¡∞Ê±ÿæø°£
//Copyright(C) π„÷› ––«“ÌµÁ◊”ø∆ºº”–œﬁπ´Àæ 2009-2019
//All rights reserved									  
//////////////////////////////////////////////////////////////////////////////////
 
//∫ÏÕ‚“£øÿ≥ı ºªØ
//…Ë÷√IO“‘º∞∂® ±∆˜4µƒ ‰»Î≤∂ªÒ
void Remote_Init(void)    			  
{  
	GPIO_InitTypeDef GPIO_InitStructure;
	NVIC_InitTypeDef NVIC_InitStructure;
	TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;
	TIM_ICInitTypeDef  TIM_ICInitStructure;  
 
 	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA|RCC_APB2Periph_GPIOB,ENABLE); // πƒ‹PORTB ±÷” 
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2|RCC_APB1Periph_TIM3,ENABLE);	//TIM5  ±÷” πƒ‹ 

	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0|GPIO_Pin_1|GPIO_Pin_2|GPIO_Pin_3|GPIO_Pin_6|GPIO_Pin_7;				 //PA1  ‰»Î 
 	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU; 		//…œ¿≠ ‰»Î 
 	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
 	GPIO_Init(GPIOA, &GPIO_InitStructure);
 	GPIO_SetBits(GPIOA,GPIO_Pin_0);	//≥ı ºªØGPIOA1
	GPIO_SetBits(GPIOA,GPIO_Pin_1);
	GPIO_SetBits(GPIOA,GPIO_Pin_2);
	GPIO_SetBits(GPIOA,GPIO_Pin_3);
	GPIO_SetBits(GPIOA,GPIO_Pin_6);
	GPIO_SetBits(GPIOA,GPIO_Pin_7);
	
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0|GPIO_Pin_1;
 	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU; 		//…œ¿≠ ‰»Î 
 	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
 	GPIO_Init(GPIOB, &GPIO_InitStructure);
 	GPIO_SetBits(GPIOB,GPIO_Pin_0);	//≥ı ºªØGPIOB
	GPIO_SetBits(GPIOB,GPIO_Pin_1);
						  
 	TIM_TimeBaseStructure.TIM_Period = 10000; //…Ë∂®º∆ ˝∆˜◊‘∂Ø÷ÿ◊∞÷µ ◊Ó¥Û10ms“Á≥ˆ  
	TIM_TimeBaseStructure.TIM_Prescaler =(72-1); 	//‘§∑÷∆µ∆˜,1Mµƒº∆ ˝∆µ¬ ,1usº”1.	   
	TIM_TimeBaseStructure.TIM_ClockDivision = TIM_CKD_DIV1; //…Ë÷√ ±÷”∑÷∏Ó:TDTS = Tck_tim
	TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;  //TIMœÚ…œº∆ ˝ƒ£ Ω
	TIM_TimeBaseInit(TIM2, &TIM_TimeBaseStructure); //∏˘æ›÷∏∂®µƒ≤Œ ˝≥ı ºªØTIMx
	
	TIM_TimeBaseStructure.TIM_Period = 10000; //…Ë∂®º∆ ˝∆˜◊‘∂Ø÷ÿ◊∞÷µ ◊Ó¥Û10ms“Á≥ˆ  
	TIM_TimeBaseStructure.TIM_Prescaler =(72-1); 	//‘§∑÷∆µ∆˜,1Mµƒº∆ ˝∆µ¬ ,1usº”1.	   
	TIM_TimeBaseStructure.TIM_ClockDivision = TIM_CKD_DIV1; //…Ë÷√ ±÷”∑÷∏Ó:TDTS = Tck_tim
	TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;  //TIMœÚ…œº∆ ˝ƒ£ Ω
	TIM_TimeBaseInit(TIM3, &TIM_TimeBaseStructure); //∏˘æ›÷∏∂®µƒ≤Œ ˝≥ı ºªØTIMx


  TIM_ICInitStructure.TIM_Channel = TIM_Channel_1;  // —°‘Ò ‰»Î∂À IC2”≥…‰µΩTI5…œ
  TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;	//…œ…˝—ÿ≤∂ªÒ
  TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
  TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //≈‰÷√ ‰»Î∑÷∆µ,≤ª∑÷∆µ 
  TIM_ICInitStructure.TIM_ICFilter = 0x03;//IC4F=0011 ≈‰÷√ ‰»Î¬À≤®∆˜ 8∏ˆ∂® ±∆˜ ±÷”÷‹∆⁄¬À≤®
  TIM_ICInit(TIM2, &TIM_ICInitStructure);//≥ı ºªØ∂® ±∆˜ ‰»Î≤∂ªÒÕ®µ¿

  TIM_ICInitStructure.TIM_Channel = TIM_Channel_2;  // —°‘Ò ‰»Î∂À IC2”≥…‰µΩTI5…œ
  TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;	//…œ…˝—ÿ≤∂ªÒ
  TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
  TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //≈‰÷√ ‰»Î∑÷∆µ,≤ª∑÷∆µ 
  TIM_ICInitStructure.TIM_ICFilter = 0x03;//IC4F=0011 ≈‰÷√ ‰»Î¬À≤®∆˜ 8∏ˆ∂® ±∆˜ ±÷”÷‹∆⁄¬À≤®
  TIM_ICInit(TIM2, &TIM_ICInitStructure);//≥ı ºªØ∂® ±∆˜ ‰»Î≤∂ªÒÕ®µ¿
	
	TIM_ICInitStructure.TIM_Channel = TIM_Channel_3;  // —°‘Ò ‰»Î∂À IC2”≥…‰µΩTI5…œ
  TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;	//…œ…˝—ÿ≤∂ªÒ
  TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
  TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //≈‰÷√ ‰»Î∑÷∆µ,≤ª∑÷∆µ 
  TIM_ICInitStructure.TIM_ICFilter = 0x03;//IC4F=0011 ≈‰÷√ ‰»Î¬À≤®∆˜ 8∏ˆ∂® ±∆˜ ±÷”÷‹∆⁄¬À≤®
  TIM_ICInit(TIM2, &TIM_ICInitStructure);//≥ı ºªØ∂® ±∆˜ ‰»Î≤∂ªÒÕ®µ¿
	
	TIM_ICInitStructure.TIM_Channel = TIM_Channel_4;  // —°‘Ò ‰»Î∂À IC2”≥…‰µΩTI5…œ
  TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;	//…œ…˝—ÿ≤∂ªÒ
  TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
  TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //≈‰÷√ ‰»Î∑÷∆µ,≤ª∑÷∆µ 
  TIM_ICInitStructure.TIM_ICFilter = 0x03;//IC4F=0011 ≈‰÷√ ‰»Î¬À≤®∆˜ 8∏ˆ∂® ±∆˜ ±÷”÷‹∆⁄¬À≤®
  TIM_ICInit(TIM2, &TIM_ICInitStructure);//≥ı ºªØ∂® ±∆˜ ‰»Î≤∂ªÒÕ®µ¿
	
	TIM_ICInitStructure.TIM_Channel = TIM_Channel_1;  // —°‘Ò ‰»Î∂À IC2”≥…‰µΩTI5…œ
  TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;	//…œ…˝—ÿ≤∂ªÒ
  TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
  TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //≈‰÷√ ‰»Î∑÷∆µ,≤ª∑÷∆µ 
  TIM_ICInitStructure.TIM_ICFilter = 0x03;//IC4F=0011 ≈‰÷√ ‰»Î¬À≤®∆˜ 8∏ˆ∂® ±∆˜ ±÷”÷‹∆⁄¬À≤®
  TIM_ICInit(TIM3, &TIM_ICInitStructure);//≥ı ºªØ∂® ±∆˜ ‰»Î≤∂ªÒÕ®µ¿
	
	TIM_ICInitStructure.TIM_Channel = TIM_Channel_2;  // —°‘Ò ‰»Î∂À IC2”≥…‰µΩTI5…œ
  TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;	//…œ…˝—ÿ≤∂ªÒ
  TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
  TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //≈‰÷√ ‰»Î∑÷∆µ,≤ª∑÷∆µ 
  TIM_ICInitStructure.TIM_ICFilter = 0x03;//IC4F=0011 ≈‰÷√ ‰»Î¬À≤®∆˜ 8∏ˆ∂® ±∆˜ ±÷”÷‹∆⁄¬À≤®
  TIM_ICInit(TIM3, &TIM_ICInitStructure);//≥ı ºªØ∂® ±∆˜ ‰»Î≤∂ªÒÕ®µ¿
	
	TIM_ICInitStructure.TIM_Channel = TIM_Channel_3;  // —°‘Ò ‰»Î∂À IC2”≥…‰µΩTI5…œ
  TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;	//…œ…˝—ÿ≤∂ªÒ
  TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
  TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //≈‰÷√ ‰»Î∑÷∆µ,≤ª∑÷∆µ 
  TIM_ICInitStructure.TIM_ICFilter = 0x03;//IC4F=0011 ≈‰÷√ ‰»Î¬À≤®∆˜ 8∏ˆ∂® ±∆˜ ±÷”÷‹∆⁄¬À≤®
  TIM_ICInit(TIM3, &TIM_ICInitStructure);//≥ı ºªØ∂® ±∆˜ ‰»Î≤∂ªÒÕ®µ¿
	
	TIM_ICInitStructure.TIM_Channel = TIM_Channel_4;  // —°‘Ò ‰»Î∂À IC2”≥…‰µΩTI5…œ
  TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;	//…œ…˝—ÿ≤∂ªÒ
  TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
  TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //≈‰÷√ ‰»Î∑÷∆µ,≤ª∑÷∆µ 
  TIM_ICInitStructure.TIM_ICFilter = 0x03;//IC4F=0011 ≈‰÷√ ‰»Î¬À≤®∆˜ 8∏ˆ∂® ±∆˜ ±÷”÷‹∆⁄¬À≤®
  TIM_ICInit(TIM3, &TIM_ICInitStructure);//≥ı ºªØ∂® ±∆˜ ‰»Î≤∂ªÒÕ®µ¿

	TIM_Cmd(TIM3,ENABLE ); 
  TIM_Cmd(TIM2,ENABLE ); 	// πƒ‹∂® ±∆˜5
 
 						
	NVIC_InitStructure.NVIC_IRQChannel =TIM2_IRQn;  //TIM5÷–∂œ
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;  //œ»’º”≈œ»º∂0º∂
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 3;  //¥””≈œ»º∂3º∂
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; //IRQÕ®µ¿±ª πƒ‹
	NVIC_Init(&NVIC_InitStructure);  //∏˘æ›NVIC_InitStruct÷–÷∏∂®µƒ≤Œ ˝≥ı ºªØÕ‚…ËNVICºƒ¥Ê∆˜	
 
 	TIM_ITConfig( TIM2,TIM_IT_Update|TIM_IT_CC1|TIM_IT_CC2|TIM_IT_CC3|TIM_IT_CC4,ENABLE);//‘ –Ì∏¸–¬÷–∂œ ,‘ –ÌCC2IE≤∂ªÒ÷–∂œ	
	
	NVIC_InitStructure.NVIC_IRQChannel =TIM3_IRQn;  //TIM5÷–∂œ
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;  //œ»’º”≈œ»º∂0º∂
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 2;  //¥””≈œ»º∂3º∂
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; //IRQÕ®µ¿±ª πƒ‹
	NVIC_Init(&NVIC_InitStructure);  //∏˘æ›NVIC_InitStruct÷–÷∏∂®µƒ≤Œ ˝≥ı ºªØÕ‚…ËNVICºƒ¥Ê∆˜	
 
 	TIM_ITConfig( TIM3,TIM_IT_Update|TIM_IT_CC1|TIM_IT_CC2|TIM_IT_CC3|TIM_IT_CC4,ENABLE);//‘ –Ì∏¸–¬÷–∂œ ,‘ –ÌCC2IE≤∂ªÒ÷–
}
  
u32 Dval0,Dval_in0,Dval1,Dval_in1,Dval2,Dval_in2,Dval3,Dval_in3,Dval4,Dval_in4,
    Dval5,Dval_in5,Dval6,Dval_in6,Dval7,Dval_in7,Dval_in8,Dval8;		//œ¬Ωµ—ÿ ±º∆ ˝∆˜µƒ÷µ˝	  
//∂® ±∆˜5÷–∂œ∑˛ŒÒ≥Ã–Ú	 
u8 cc1_more=0,cc2_more=0,cc3_more=0,cc4_more=0,cc5_more=0,cc6_more=0,cc7_more=0,cc8_more=0;
u8 hw_cc1=0,hw_cc2=0,hw_cc3=0,hw_cc4=0,hw_cc5=0,hw_cc6=0,hw_cc7=0,hw_cc8=0;

u8 	RmtSta1=0,RmtSta2=0,RmtSta3=0,RmtSta4=0,RmtSta5=0,RmtSta6=0,RmtSta7=0,RmtSta8=0;

u8 HW1_MARK=0,HW2_MARK=0,HW3_MARK=0,HW4_MARK=0,HW5_MARK=0,HW6_MARK=0,HW7_MARK=0,HW8_MARK=0;

void Remote(u8*RmtSta,u8*HW_MARK,u16 Dval,u8* hw_cch);

void TIM2_IRQHandler(void)
{ 		    	 
  if(TIM_GetITStatus(TIM2,TIM_IT_Update)!=RESET)
	{
		cc1_more++;
		cc2_more++;
		cc3_more++;
		cc4_more++;
		if(cc1_more>=2) {cc1_more=0;HW1_MARK=0;}
		if(cc2_more>=2) {cc2_more=0;HW2_MARK=0;}
		if(cc3_more>=2) {cc3_more=0;HW3_MARK=0;}
		if(cc4_more>=2) {cc4_more=0;HW4_MARK=0;}
		TIM_ClearFlag(TIM2,TIM_IT_Update);	    
	}
	if(TIM_GetITStatus(TIM2,TIM_IT_CC1)!=RESET)
	{
		if(RDATA)//…œ…˝—ÿ≤∂ªÒ
		{
			TIM_OC1PolarityConfig(TIM2,TIM_ICPolarity_Falling);		//CC1P=1 …Ë÷√Œ™œ¬Ωµ—ÿ≤∂ªÒ				
	    cc1_more=0;
			Dval_in0=TIM_GetCapture1(TIM2);	
			RmtSta1|=0X10;
		}else //œ¬Ωµ—ÿ≤∂ªÒ
		{	
  		 Dval0=cc1_more*10000+TIM_GetCapture1(TIM2)-Dval_in0;//∂¡»°CCR1“≤ø…“‘«ÂCC1IF±Í÷æŒª
			 TIM_OC1PolarityConfig(TIM2,TIM_ICPolarity_Rising); //CC4P=0	…Ë÷√Œ™…œ…˝—ÿ≤∂ªÒ
			 Remote(&RmtSta1,&HW1_MARK,Dval0,&hw_cc1);
		}
		TIM_ClearFlag(TIM2,TIM_IT_CC1);
	}	
	else
 	if(TIM_GetITStatus(TIM2,TIM_IT_CC2)!=RESET)
	{	  
		if(RDATA1)//…œ…˝—ÿ≤∂ªÒ
		{
			TIM_OC2PolarityConfig(TIM2,TIM_ICPolarity_Falling);		//CC1P=1 …Ë÷√Œ™œ¬Ωµ—ÿ≤∂ªÒ				
	    cc2_more=0;
			Dval_in1=TIM_GetCapture2(TIM2);	
			RmtSta2|=0X10;
		}else//œ¬Ωµ—ÿ≤∂ªÒ
		{	
  		 Dval1=cc2_more*10000+TIM_GetCapture2(TIM2)-Dval_in1;//∂¡»°CCR1“≤ø…“‘«ÂCC1IF±Í÷æŒª
			 TIM_OC2PolarityConfig(TIM2,TIM_ICPolarity_Rising); //CC4P=0	…Ë÷√Œ™…œ…˝—ÿ≤∂ªÒ
 			
			 Remote(&RmtSta2,&HW2_MARK,Dval1,&hw_cc2);
		}	
		TIM_ClearFlag(TIM2,TIM_IT_CC2);
	}
else
	if(TIM_GetITStatus(TIM2,TIM_IT_CC3)!=RESET)
	{	  
		if(RDATA2)//…œ…˝—ÿ≤∂ªÒ
		{
			TIM_OC3PolarityConfig(TIM2,TIM_ICPolarity_Falling);		//CC1P=1 …Ë÷√Œ™œ¬Ωµ—ÿ≤∂ªÒ				
	    cc3_more=0;
			Dval_in2=TIM_GetCapture3(TIM2);
			RmtSta3|=0X10;
		}else//œ¬Ωµ—ÿ≤∂ªÒ
		{			
  		 Dval2=cc3_more*10000+TIM_GetCapture3(TIM2)-Dval_in2;//∂¡»°CCR1“≤ø…“‘«ÂCC1IF±Í÷æŒª
			 TIM_OC3PolarityConfig(TIM2,TIM_ICPolarity_Rising); //CC4P=0	…Ë÷√Œ™…œ…˝—ÿ≤∂ªÒ

				 Remote(&RmtSta3,&HW3_MARK,Dval2,&hw_cc3);
		}	
		TIM_ClearFlag(TIM2,TIM_IT_CC3);
	}	
	else
	if(TIM_GetITStatus(TIM2,TIM_IT_CC4)!=RESET)
	{	  
		if(RDATA3)//…œ…˝—ÿ≤∂ªÒ
		{
			TIM_OC4PolarityConfig(TIM2,TIM_ICPolarity_Falling);		//CC1P=1 …Ë÷√Œ™œ¬Ωµ—ÿ≤∂ªÒ				
	    cc4_more=0;
			Dval_in3=TIM_GetCapture4(TIM2);	
			RmtSta4|=0X10;
		}else//œ¬Ωµ—ÿ≤∂ªÒ
		{			
  		 Dval3=cc4_more*10000+TIM_GetCapture4(TIM2)-Dval_in3;//∂¡»°CCR1“≤ø…“‘«ÂCC1IF±Í÷æŒª
			 TIM_OC4PolarityConfig(TIM2,TIM_ICPolarity_Rising); //CC4P=0	…Ë÷√Œ™…œ…˝—ÿ≤∂ªÒ
 			 Remote(&RmtSta4,&HW4_MARK,Dval3,&hw_cc4);
		}	
		TIM_ClearFlag(TIM2,TIM_IT_CC4);
	}	    
}


void TIM3_IRQHandler(void){ 		    	 
  if(TIM_GetITStatus(TIM3,TIM_IT_Update)!=RESET)
	{
		cc5_more++;
		cc6_more++;
		cc7_more++;
		cc8_more++;
		if(cc5_more>=2) {cc5_more=0;HW5_MARK=0;}
		if(cc6_more>=2) {cc6_more=0;HW6_MARK=0;}
		if(cc7_more>=2) {cc7_more=0;HW7_MARK=0;}
		if(cc8_more>=2) {cc8_more=0;HW8_MARK=0;}
		TIM_ClearFlag(TIM3,TIM_IT_Update);	    
	}
	if(TIM_GetITStatus(TIM3,TIM_IT_CC1)!=RESET)
	{	  
		if(RDATA4)//…œ…˝—ÿ≤∂ªÒ
		{
			TIM_OC1PolarityConfig(TIM3,TIM_ICPolarity_Falling);		//CC1P=1 …Ë÷√Œ™œ¬Ωµ—ÿ≤∂ªÒ				
	    cc5_more=0;
			Dval_in4=TIM_GetCapture1(TIM3);	
			RmtSta5|=0X10;
		}else //œ¬Ωµ—ÿ≤∂ªÒ
		{			
  		 Dval4=cc5_more*10000+TIM_GetCapture1(TIM3)-Dval_in4;//∂¡»°CCR1“≤ø…“‘«ÂCC1IF±Í÷æŒª
			 TIM_OC1PolarityConfig(TIM3,TIM_ICPolarity_Rising); //CC4P=0	…Ë÷√Œ™…œ…˝—ÿ≤∂ªÒ
 			
			 Remote(&RmtSta5,&HW5_MARK,Dval4,&hw_cc5);
		}	
		TIM_ClearFlag(TIM3,TIM_IT_CC1);
	}	
	else
 	if(TIM_GetITStatus(TIM3,TIM_IT_CC2)!=RESET)
	{	  
		if(RDATA5)//…œ…˝—ÿ≤∂ªÒ
		{
			TIM_OC2PolarityConfig(TIM3,TIM_ICPolarity_Falling);		//CC1P=1 …Ë÷√Œ™œ¬Ωµ—ÿ≤∂ªÒ				
	    cc6_more=0;
			Dval_in5=TIM_GetCapture2(TIM3);
			RmtSta6|=0X10;
		}else//œ¬Ωµ—ÿ≤∂ªÒ
		{			
  		 Dval5=cc6_more*10000+TIM_GetCapture2(TIM3)-Dval_in5;//∂¡»°CCR1“≤ø…“‘«ÂCC1IF±Í÷æŒª
			 TIM_OC2PolarityConfig(TIM3,TIM_ICPolarity_Rising); //CC4P=0	…Ë÷√Œ™…œ…˝—ÿ≤∂ªÒ
				
				 Remote(&RmtSta6,&HW6_MARK,Dval5,&hw_cc6);
		}	
		TIM_ClearFlag(TIM3,TIM_IT_CC2);
	}
else
	if(TIM_GetITStatus(TIM3,TIM_IT_CC3)!=RESET)
	{	  
		if(RDATB6)//…œ…˝—ÿ≤∂ªÒ
		{
			TIM_OC3PolarityConfig(TIM3,TIM_ICPolarity_Falling);		//CC1P=1 …Ë÷√Œ™œ¬Ωµ—ÿ≤∂ªÒ				
	    cc7_more=0;
			Dval_in6=TIM_GetCapture3(TIM3);	
			RmtSta7|=0X10;
		}else //œ¬Ωµ—ÿ≤∂ªÒ
		{			
  		 Dval6=cc7_more*10000+TIM_GetCapture3(TIM3)-Dval_in6;//∂¡»°CCR1“≤ø…“‘«ÂCC1IF±Í÷æŒª
			 TIM_OC3PolarityConfig(TIM3,TIM_ICPolarity_Rising); //CC4P=0	…Ë÷√Œ™…œ…˝—ÿ≤∂ªÒ

			 Remote(&RmtSta7,&HW7_MARK,Dval6,&hw_cc7);
		}	
		TIM_ClearFlag(TIM3,TIM_IT_CC3);
	}else
		if(TIM_GetITStatus(TIM3,TIM_IT_CC4)!=RESET)
	{
		if(RDATB7)//…œ…˝—ÿ≤∂ªÒ
		{
			TIM_OC4PolarityConfig(TIM3,TIM_ICPolarity_Falling);		//CC1P=1 …Ë÷√Œ™œ¬Ωµ—ÿ≤∂ªÒ				
	    cc8_more=0;
			Dval_in7=TIM_GetCapture4(TIM3);	
			RmtSta8|=0X10;
		}else //œ¬Ωµ—ÿ≤∂ªÒ
		{			
  		 Dval7=cc8_more*10000+TIM_GetCapture4(TIM3)-Dval_in7;//∂¡»°CCR1“≤ø…“‘«ÂCC1IF±Í÷æŒª
			 TIM_OC4PolarityConfig(TIM3,TIM_ICPolarity_Rising); //CC4P=0	…Ë÷√Œ™…œ…˝—ÿ≤∂ªÒ

				 Remote(&RmtSta8,&HW8_MARK,Dval7,&hw_cc8);
		}	
		TIM_ClearFlag(TIM3,TIM_IT_CC4);
	}	
}

int hw_xh=0,hw_ch0=0;

void Remote(u8*RmtSta,u8*HW_MARK,u16 Dval,u8* hw_cch)
{
		 if(*RmtSta&0X10)
			 {
				 if(*RmtSta&0X80)
				 {
					if(Dval>500&&Dval<1500)
					{
							(*hw_cch)++;
						  if(*hw_cch==20)  {*HW_MARK=1;*RmtSta&=0X7F;*hw_cch=0;}
					}
					else  
					{
						*HW_MARK=0;
						hw_cch=0;
						*RmtSta&=0X7F;
					}
				 }
				 else if(Dval>3800&&Dval<4200)
				 {
						*RmtSta|=0X80;
				 }
				 else   
				 {
					 *HW_MARK=0;
				 }
			 }
}




